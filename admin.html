<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel</title>
    <!-- The API key is now a placeholder that the server will replace -->
    <script src="https://cdn.tiny.cloud/1/YOUR_TINYMCE_API_KEY_PLACEHOLDER/tinymce/8/tinymce.min.js" referrerpolicy="origin" crossorigin="anonymous"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f4f4f4; }
        h1, h2 { color: #333; }
        #app { max-width: 1000px; margin: auto; background: white; padding: 20px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        .project { border: 1px solid #ddd; padding: 15px; margin-bottom: 20px; border-radius: 5px; }
        .project h3 { margin-top: 0; }
        .project-images { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px; }
        .project-image { position: relative; }
        .project-image img { width: 100px; height: 100px; object-fit: cover; border-radius: 4px; }
        .delete-img-btn {
            position: absolute; top: 2px; right: 2px; background: rgba(0,0,0,0.7); color: white;
            border: none; border-radius: 50%; cursor: pointer; font-size: 14px; width: 20px; height: 20px;
            line-height: 20px; text-align: center;
        }
        button {
            background-color: #007bff; color: white; border: none; padding: 10px 15px;
            border-radius: 4px; cursor: pointer; font-size: 16px; margin-right: 5px;
        }
        button:hover { background-color: #0056b3; }
        .delete-btn { background-color: #dc3545; }
        .delete-btn:hover { background-color: #c82333; }
        form { margin-top: 20px; }
        input[type="text"], input[type="file"] {
            width: 100%; padding: 8px; margin: 10px 0; box-sizing: border-box;
        }
    </style>
</head>
<body>

    <div id="app">
        <button id="logout-btn" style="position: absolute; top: 20px; right: 20px;">Logout</button>
        <h1 data-testid="admin-page-title">Project Management</h1>

        <!-- Create New Project -->
        <div id="create-project">
            <h2>Create New Project</h2>
            <form id="create-project-form">
                <input type="text" id="new-project-title" placeholder="Project Title" required>
                <textarea id="new-tile-summary" placeholder="Tile Summary"></textarea>
                <label for="new-modal-description">Modal Description</label>
                <textarea id="new-modal-description"></textarea>
                <button type="submit">Create Project</button>
            </form>
        </div>

        <hr>

        <!-- Existing Projects -->
        <div id="projects-list">
            <h2>Existing Projects</h2>
            <!-- Projects will be loaded here -->
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const projectsList = document.getElementById('projects-list');
        const createProjectForm = document.getElementById('create-project-form');

        // This function returns the new, enhanced TinyMCE configuration
        function getTinyMceConfig(selector) {
            return {
                selector: selector,
                plugins: [
                  'anchor', 'autolink', 'charmap', 'codesample', 'emoticons', 'link', 'lists', 'media', 'searchreplace', 'table', 'visualblocks', 'wordcount',
                  'checklist', 'mediaembed', 'casechange', 'formatpainter', 'pageembed', 'a11ychecker', 'tinymcespellchecker', 'permanentpen', 'powerpaste', 'advtable', 'advcode', 'advtemplate', 'ai', 'uploadcare', 'mentions', 'tinycomments', 'tableofcontents', 'footnotes', 'mergetags', 'autocorrect', 'typography', 'inlinecss', 'markdown','importword', 'exportword', 'exportpdf'
                ],
                toolbar: 'undo redo | blocks fontfamily fontsize | bold italic underline strikethrough | link media table mergetags | addcomment showcomments | spellcheckdialog a11ycheck typography uploadcare | align lineheight | checklist numlist bullist indent outdent | emoticons charmap | removeformat',
                tinycomments_mode: 'embedded',
                tinycomments_author: 'Author name',
                mergetags_list: [
                  { value: 'First.Name', title: 'First Name' },
                  { value: 'Email', title: 'Email' },
                ],
                ai_request: (request, respondWith) => respondWith.string(() => Promise.reject('See docs to implement AI Assistant')),
                uploadcare_public_key: '1968d2dca0e403257add',
            };
        }

        // Initialize TinyMCE for the new project text areas
        tinymce.init(getTinyMceConfig('#new-modal-description'));

        // Fetch and display projects
        async function loadProjects() {
            const response = await fetch('/api/projects');
            const projects = await response.json();
            projectsList.innerHTML = '<h2>Existing Projects</h2>';

            projects.forEach((project, index) => {
                const projectEl = document.createElement('div');
                projectEl.className = 'project';
                projectEl.innerHTML = `
                    <h3><input type="text" value="${project.title}" data-project-index="${index}" class="project-title-input"></h3>

                    <p><strong>Tile Summary:</strong></p>
                    <textarea data-project-index="${index}" class="tile-summary-input">${project.tileSummary || ''}</textarea>

                    <p><strong>Tile Image:</strong></p>
                    <img src="${project.tileImage || 'images/placeholder-project.png'}" class="tile-image-preview" width="100">
                    <form class="tile-image-form" data-project-index="${index}">
                        <input type="file" name="tileImage">
                        <button type="submit">Upload Tile Image</button>
                    </form>

                    <p><strong>Modal Description:</strong></p>
                    <div id="description-${index}" class="modal-description-div">${project.modalDescription || ''}</div>

                    <p><strong>Modal Images:</strong></p>
                    <div class="project-images" id="images-${index}">
                        ${(project.modalImages || []).map((img, imgIndex) => `
                            <div class="project-image">
                                <img src="${img}" alt="Project Image">
                                <button class="delete-img-btn" data-project-index="${index}" data-image-index="${imgIndex}">&times;</button>
                            </div>
                        `).join('')}
                    </div>
                    <form class="upload-form" data-project-index="${index}">
                        <input type="file" name="modalImages" multiple>
                        <button type="submit">Upload Modal Images</button>
                    </form>

                    <button class="save-btn" data-project-index="${index}">Save All Text</button>
                    <button class="edit-btn" data-project-index="${index}">Edit Description</button>
                    <button class="delete-btn" data-project-index="${index}">Delete Project</button>
                `;
                projectsList.appendChild(projectEl);

                // Add event listener for the "Edit" button
                projectEl.querySelector('.edit-btn').addEventListener('click', () => {
                    const descriptionDiv = document.getElementById(`description-${index}`);
                    const editor = tinymce.get(`description-${index}`);

                    if (!editor) {
                        tinymce.init(getTinyMceConfig(`#description-${index}`));
                        projectEl.querySelector('.edit-btn').textContent = "Finish Editing";
                    } else {
                        editor.remove();
                        projectEl.querySelector('.edit-btn').textContent = "Edit Description";
                    }
                });
            });
        }

        // Create a new project
        createProjectForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const title = document.getElementById('new-project-title').value;
            const tileSummary = document.getElementById('new-tile-summary').value;
            const modalDescription = tinymce.get('new-modal-description').getContent();

            await fetch('/api/projects', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ title, tileSummary, modalDescription })
            });
            createProjectForm.reset();
            tinymce.get('new-modal-description').setContent('');
            loadProjects();
        });

        // Update a project's text content
        async function updateProject(index, title, tileSummary, modalDescription) {
            await fetch(`/api/projects/${index}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ title, tileSummary, modalDescription })
            });
            loadProjects();
        }

        // Handle project deletion, saving, and image uploads
        projectsList.addEventListener('click', async (e) => {
            if (e.target.classList.contains('delete-btn')) {
                const index = e.target.dataset.projectIndex;
                if (confirm('Are you sure you want to delete this project?')) {
                    await fetch(`/api/projects/${index}`, { method: 'DELETE' });
                    loadProjects();
                }
            } else if (e.target.classList.contains('save-btn')) {
                const index = e.target.dataset.projectIndex;
                const projectEl = e.target.closest('.project');
                const title = projectEl.querySelector('.project-title-input').value;
                const tileSummary = projectEl.querySelector('.tile-summary-input').value;

                let modalDescription;
                const editor = tinymce.get(`description-${index}`);
                if (editor) {
                    modalDescription = editor.getContent();
                } else {
                    modalDescription = projectEl.querySelector('.modal-description-div').innerHTML;
                }

                updateProject(index, title, tileSummary, modalDescription);
            } else if (e.target.classList.contains('delete-img-btn')) {
                const projectIndex = e.target.dataset.projectIndex;
                const imageIndex = e.target.dataset.imageIndex;
                 if (confirm('Are you sure you want to delete this image?')) {
                    await fetch(`/api/projects/${projectIndex}/modal-images/${imageIndex}`, { method: 'DELETE' });
                    loadProjects();
                }
            }
        });

        projectsList.addEventListener('submit', async (e) => {
            e.preventDefault();
            const index = e.target.dataset.projectIndex;
            const formData = new FormData(e.target);

            if (e.target.classList.contains('upload-form')) {
                await fetch(`/api/projects/${index}/modal-images`, {
                    method: 'POST',
                    body: formData
                });
            } else if (e.target.classList.contains('tile-image-form')) {
                await fetch(`/api/projects/${index}/tile-image`, {
                    method: 'POST',
                    body: formData
                });
            }
            loadProjects();
        });

        document.getElementById('logout-btn').addEventListener('click', async () => {
            const response = await fetch('/logout', { method: 'POST' });
            if (response.ok) {
                window.location.href = '/login';
            }
        });

        loadProjects();
    });
    </script>

</body>
</html>
