<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel</title>
    <script src="https://cdn.tiny.cloud/1/3n17gnuookphbwng19976ys835re9sbihbx9luba62brkc98/tinymce/8/tinymce.min.js" referrerpolicy="origin" crossorigin="anonymous"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f4f4f4; }
        h1, h2 { color: #333; }
        #app { max-width: 1000px; margin: auto; background: white; padding: 20px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        .project { border: 1px solid #ddd; padding: 15px; margin-bottom: 20px; border-radius: 5px; }
        .project h3 { margin-top: 0; }
        .project-images { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px; }
        .project-image { position: relative; }
        .project-image img { width: 100px; height: 100px; object-fit: cover; border-radius: 4px; }
        .delete-img-btn {
            position: absolute; top: 2px; right: 2px; background: rgba(0,0,0,0.7); color: white;
            border: none; border-radius: 50%; cursor: pointer; font-size: 14px; width: 20px; height: 20px;
            line-height: 20px; text-align: center;
        }
        button {
            background-color: #007bff; color: white; border: none; padding: 10px 15px;
            border-radius: 4px; cursor: pointer; font-size: 16px; margin-right: 5px;
        }
        button:hover { background-color: #0056b3; }
        .delete-btn { background-color: #dc3545; }
        .delete-btn:hover { background-color: #c82333; }
        form { margin-top: 20px; }
        input[type="text"], input[type="file"] {
            width: 100%; padding: 8px; margin: 10px 0; box-sizing: border-box;
        }
    </style>
</head>
<body>

    <div id="app">
        <h1>Project Management</h1>

        <!-- Create New Project -->
        <div id="create-project">
            <h2>Create New Project</h2>
            <form id="create-project-form">
                <input type="text" id="new-project-title" placeholder="Project Title" required>
                <textarea id="new-project-description"></textarea>
                <button type="submit">Create Project</button>
            </form>
        </div>

        <hr>

        <!-- Existing Projects -->
        <div id="projects-list">
            <h2>Existing Projects</h2>
            <!-- Projects will be loaded here -->
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const projectsList = document.getElementById('projects-list');
        const createProjectForm = document.getElementById('create-project-form');

        // Initialize TinyMCE for new project description
        tinymce.init({
            selector: '#new-project-description',
            height: 300,
            menubar: false,
            plugins: [
                'advlist autolink lists link image charmap print preview anchor',
                'searchreplace visualblocks code fullscreen',
                'insertdatetime media table paste code help wordcount'
            ],
            toolbar: 'undo redo | formatselect | ' +
            'bold italic backcolor | alignleft aligncenter ' +
            'alignright alignjustify | bullist numlist outdent indent | ' +
            'removeformat | help'
        });

        // Fetch and display projects
        async function loadProjects() {
            const response = await fetch('/api/projects');
            const projects = await response.json();
            projectsList.innerHTML = '<h2>Existing Projects</h2>';

            projects.forEach((project, index) => {
                const projectEl = document.createElement('div');
                projectEl.className = 'project';
                projectEl.innerHTML = `
                    <h3>${project.title}</h3>
                    <div id="description-${index}">${project.description}</div>
                    <div class="project-images" id="images-${index}">
                        ${project.images.map((img, imgIndex) => `
                            <div class="project-image">
                                <img src="${img}" alt="Project Image">
                                <button class="delete-img-btn" data-project-index="${index}" data-image-index="${imgIndex}">&times;</button>
                            </div>
                        `).join('')}
                    </div>
                    <form class="upload-form" data-project-index="${index}">
                        <input type="file" name="images" multiple>
                        <button type="submit">Upload Images</button>
                    </form>
                    <button class="edit-btn" data-project-index="${index}">Edit</button>
                    <button class="delete-btn" data-project-index="${index}">Delete Project</button>
                `;
                projectsList.appendChild(projectEl);

                // Add TinyMCE to existing project descriptions when editing
                projectEl.querySelector('.edit-btn').addEventListener('click', () => {
                    const descriptionDiv = document.getElementById(`description-${index}`);
                    if (!descriptionDiv.querySelector('.tox-tinymce')) {
                        tinymce.init({
                            selector: `#description-${index}`,
                            height: 300,
                            menubar: false,
                            plugins: [
                                'advlist autolink lists link image charmap print preview anchor',
                                'searchreplace visualblocks code fullscreen',
                                'insertdatetime media table paste code help wordcount'
                            ],
                            toolbar: 'undo redo | formatselect | ' +
                            'bold italic backcolor | alignleft aligncenter ' +
                            'alignright alignjustify | bullist numlist outdent indent | ' +
                            'removeformat | help'
                        });
                        projectEl.querySelector('.edit-btn').textContent = "Save";
                    } else {
                        const newDescription = tinymce.get(`description-${index}`).getContent();
                        updateProject(index, project.title, newDescription);
                        tinymce.get(`description-${index}`).remove();
                        descriptionDiv.innerHTML = newDescription; // Show saved content
                        projectEl.querySelector('.edit-btn').textContent = "Edit";
                    }
                });
            });
        }

        // Create a new project
        createProjectForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const title = document.getElementById('new-project-title').value;
            const description = tinymce.get('new-project-description').getContent();
            await fetch('/api/projects', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ title, description })
            });
            createProjectForm.reset();
            tinymce.get('new-project-description').setContent('');
            loadProjects();
        });

        // Update a project
        async function updateProject(index, title, description) {
            await fetch(`/api/projects/${index}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ title, description })
            });
            loadProjects();
        }

        // Handle project deletion and image uploads
        projectsList.addEventListener('click', async (e) => {
            if (e.target.classList.contains('delete-btn')) {
                const index = e.target.dataset.projectIndex;
                if (confirm('Are you sure you want to delete this project?')) {
                    await fetch(`/api/projects/${index}`, { method: 'DELETE' });
                    loadProjects();
                }
            } else if (e.target.classList.contains('delete-img-btn')) {
                const projectIndex = e.target.dataset.projectIndex;
                const imageIndex = e.target.dataset.imageIndex;
                 if (confirm('Are you sure you want to delete this image?')) {
                    await fetch(`/api/projects/${projectIndex}/images/${imageIndex}`, { method: 'DELETE' });
                    loadProjects();
                }
            }
        });

        projectsList.addEventListener('submit', async (e) => {
            if (e.target.classList.contains('upload-form')) {
                e.preventDefault();
                const index = e.target.dataset.projectIndex;
                const formData = new FormData(e.target);
                await fetch(`/api/projects/${index}/images`, {
                    method: 'POST',
                    body: formData
                });
                loadProjects();
            }
        });

        loadProjects();
    });
    </script>

</body>
</html>