<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel</title>
    <!-- The API key is no longer needed from the server -->
    <script src="https://cdn.tiny.cloud/1/no-api-key/tinymce/8/tinymce.min.js" referrerpolicy="origin"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f4f4f4; }
        h1, h2 { color: #333; }
        #app { max-width: 1000px; margin: auto; background: white; padding: 20px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        .project { border: 1px solid #ddd; padding: 15px; margin-bottom: 20px; border-radius: 5px; }
        .project h3 { margin-top: 0; }
        .project-images { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px; }
        .project-image { position: relative; }
        .project-image img { width: 100px; height: 100px; object-fit: cover; border-radius: 4px; }
        .delete-img-btn {
            position: absolute; top: 2px; right: 2px; background: rgba(0,0,0,0.7); color: white;
            border: none; border-radius: 50%; cursor: pointer; font-size: 14px; width: 20px; height: 20px;
            line-height: 20px; text-align: center;
        }
        button {
            background-color: #007bff; color: white; border: none; padding: 10px 15px;
            border-radius: 4px; cursor: pointer; font-size: 16px; margin-right: 5px;
        }
        button:hover { background-color: #0056b3; }
        .delete-btn { background-color: #dc3545; }
        .delete-btn:hover { background-color: #c82333; }
        .download-btn { background-color: #28a745; }
        .download-btn:hover { background-color: #218838; }
        form { margin-top: 20px; }
        input[type="text"], input[type="file"], textarea {
            width: 100%; padding: 8px; margin: 10px 0; box-sizing: border-box;
        }
    </style>
</head>
<body>

    <div id="app">
        <button id="logout-btn" style="position: absolute; top: 20px; right: 20px;">Logout</button>
        <h1>Project Management</h1>
        <p><strong>Important:</strong> After making changes, click the "Save and Download JSON" button at the bottom. You must then replace the `content.json` file in the repository with the downloaded file and commit the changes.</p>

        <!-- Create New Project -->
        <div id="create-project">
            <h2>Create New Project</h2>
            <form id="create-project-form">
                <input type="text" id="new-project-title" placeholder="Project Title" required>
                <textarea id="new-tile-summary" placeholder="Tile Summary"></textarea>
                <label for="new-modal-description">Modal Description</label>
                <textarea id="new-modal-description"></textarea>
                <button type="submit">Create Project</button>
            </form>
        </div>

        <hr>

        <!-- Existing Projects -->
        <div id="projects-list">
            <h2>Existing Projects</h2>
            <!-- Projects will be loaded here -->
        </div>

        <hr>
        <button id="download-json-btn" class="download-btn">Save and Download content.json</button>
    </div>

    <!-- Scripts for client-side authentication -->
    <script src="config.js"></script>
    <script src="auth.js"></script>

    <script>
    // --- Protect Page ---
    protectPage();

    document.addEventListener('DOMContentLoaded', function() {
        const projectsList = document.getElementById('projects-list');
        const createProjectForm = document.getElementById('create-project-form');
        let projects = []; // Local cache for the projects array

        // --- Helper function to convert a file to a Base64 Data URL ---
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            });
        }

        // --- TinyMCE Configuration ---
        function getTinyMceConfig(selector) {
             return {
                selector: selector,
                plugins: 'lists link image media table wordcount',
                toolbar: 'undo redo | blocks | bold italic underline | bullist numlist | link image media | removeformat',
            };
        }
        tinymce.init(getTinyMceConfig('#new-modal-description'));

        // --- Load, Render, and Manage Projects ---
        async function loadAndRenderProjects() {
            try {
                const response = await fetch('content.json');
                const data = await response.json();
                projects = data.projects || [];
                renderProjects();
            } catch (e) {
                console.error("Failed to load or parse content.json:", e);
                projectsList.innerHTML = '<p style="color: red;">Error: Could not load projects. Is content.json valid?</p>';
            }
        }

        function renderProjects() {
            projectsList.innerHTML = '<h2>Existing Projects</h2>';
            projects.forEach((project, index) => {
                const projectEl = document.createElement('div');
                projectEl.className = 'project';
                projectEl.dataset.projectIndex = index;
                projectEl.innerHTML = `
                    <h3><input type="text" value="${project.title}" class="project-title-input"></h3>
                    <p><strong>Tile Summary:</strong></p>
                    <textarea class="tile-summary-input">${project.tileSummary || ''}</textarea>

                    <p><strong>Tile Image:</strong></p>
                    <img src="${project.tileImage || 'images/placeholder-project.png'}" class="tile-image-preview" width="100">
                    <input type="file" class="tile-image-input" accept="image/*">

                    <p><strong>Modal Description:</strong></p>
                    <textarea id="description-${index}" class="modal-description-input">${project.modalDescription || ''}</textarea>

                    <p><strong>Modal Images:</strong></p>
                    <div class="project-images">
                        ${(project.modalImages || []).map((img, imgIndex) => `
                            <div class="project-image">
                                <img src="${img}" alt="Project Image">
                                <button class="delete-img-btn" data-image-index="${imgIndex}">&times;</button>
                            </div>
                        `).join('')}
                    </div>
                    <input type="file" class="modal-images-input" multiple accept="image/*">

                    <button class="delete-btn">Delete Project</button>
                `;
                projectsList.appendChild(projectEl);
                tinymce.init(getTinyMceConfig(`#description-${index}`));
            });
        }

        // --- Event Listeners ---

        // Create a new project
        createProjectForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const newProject = {
                title: document.getElementById('new-project-title').value,
                tileSummary: document.getElementById('new-tile-summary').value,
                modalDescription: tinymce.get('new-modal-description').getContent(),
                tileImage: "",
                modalImages: []
            };
            projects.unshift(newProject);
            createProjectForm.reset();
            tinymce.get('new-modal-description').setContent('');
            renderProjects();
        });

        // Handle project modifications (delete, image uploads)
        projectsList.addEventListener('click', async (e) => {
            const projectEl = e.target.closest('.project');
            if (!projectEl) return;
            const index = parseInt(projectEl.dataset.projectIndex, 10);

            if (e.target.classList.contains('delete-btn')) {
                if (confirm('Are you sure you want to delete this project?')) {
                    projects.splice(index, 1);
                    renderProjects();
                }
            } else if (e.target.classList.contains('delete-img-btn')) {
                 if (confirm('Are you sure you want to delete this modal image?')) {
                    const imageIndex = parseInt(e.target.dataset.imageIndex, 10);
                    projects[index].modalImages.splice(imageIndex, 1);
                    renderProjects();
                }
            }
        });

        // Handle file input changes for images
        projectsList.addEventListener('change', async (e) => {
            const projectEl = e.target.closest('.project');
            if (!projectEl) return;
            const index = parseInt(projectEl.dataset.projectIndex, 10);

            if (e.target.classList.contains('tile-image-input')) {
                const file = e.target.files[0];
                if (file) {
                    projects[index].tileImage = await fileToBase64(file);
                    renderProjects(); // Re-render to show new image preview
                }
            } else if (e.target.classList.contains('modal-images-input')) {
                const files = Array.from(e.target.files);
                for (const file of files) {
                    const base64 = await fileToBase64(file);
                    projects[index].modalImages.push(base64);
                }
                renderProjects(); // Re-render to show new images
            }
        });

        // Save and Download JSON
        document.getElementById('download-json-btn').addEventListener('click', () => {
            // First, update the local projects array with the latest text content
            const projectElements = document.querySelectorAll('.project');
            projectElements.forEach((projectEl, index) => {
                const projectIndex = parseInt(projectEl.dataset.projectIndex, 10);
                const project = projects[projectIndex];

                project.title = projectEl.querySelector('.project-title-input').value;
                project.tileSummary = projectEl.querySelector('.tile-summary-input').value;

                const editor = tinymce.get(`description-${projectIndex}`);
                if (editor) {
                    project.modalDescription = editor.getContent();
                }
            });

            // Now, trigger the download
            const content = { projects: projects };
            const blob = new Blob([JSON.stringify(content, null, 2)], { type: 'application/json' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'content.json';
            a.click();
            URL.revokeObjectURL(a.href);
        });

        // --- Initial Load ---
        loadAndRenderProjects();

        // --- Logout Button ---
        document.getElementById('logout-btn').addEventListener('click', logout);
    });
    </script>

</body>
</html>
